<template>
  <div class="sidebar bg-discord-secondary flex flex-col h-full" :class="[isMobile ? (isOpen ? 'w-64' : 'w-0') : 'w-64']">
    <div class="p-4 font-semibold text-white flex justify-between items-center">
      <div>{{ $t('sidebar.channels') }}</div>
      <button v-if="isMobile && isOpen" @click="toggleSidebar" class="text-discord-text-gray hover:text-white">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
        </svg>
      </button>
    </div>
    
    <!-- ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ñ‹ Ğ² ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğ¸ Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°Ğ¼Ğ¸ ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ² -->
    <div class="px-3 py-2">
      <div class="mb-2">
        <div class="text-xs font-semibold text-discord-text-gray px-2 flex items-center mb-1">
          <span>Ğ£ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• ĞĞ‘Ğ£Ğ§Ğ•ĞĞ˜Ğ•Ğœ</span>
        </div>
        <div class="space-y-0.5">
          <div 
            v-for="channel in educationChannels" 
            :key="channel.id"
            @click="handleChannelAction(channel.id)"
            class="channel-item flex items-center px-2 py-1 rounded cursor-pointer"
            :class="{'bg-discord-dark-hover': currentChannel === channel.id}"
          >
            <span v-if="channel.id === 'lecture'" class="mr-2">ğŸ“</span>
            <span v-else-if="channel.id === 'student-management'" class="mr-2">ğŸ‘¥</span>
            <span v-else-if="channel.id === 'assignments'" class="mr-2">ğŸ“š</span>
            <span v-else-if="channel.id === 'tests'" class="mr-2">ğŸ“Š</span>
            <span v-else-if="channel.id === 'resources'" class="mr-2">ğŸ“‚</span>
            <span class="truncate">{{ channel.name }}</span>
          </div>
        </div>
      </div>
      
      <div class="mb-2">
        <div class="text-xs font-semibold text-discord-text-gray px-2 flex items-center mb-1">
          <span>ĞĞĞĞ›Ğ˜Ğ¢Ğ˜ĞšĞ</span>
        </div>
        <div class="space-y-0.5">
          <div 
            v-for="channel in analyticsChannels" 
            :key="channel.id"
            @click="handleChannelAction(channel.id)"
            class="channel-item flex items-center px-2 py-1 rounded cursor-pointer"
            :class="{'bg-discord-dark-hover': currentChannel === channel.id}"
          >
            <span v-if="channel.id === 'student-progress'" class="mr-2">ğŸ“ˆ</span>
            <span v-else-if="channel.id === 'attendance'" class="mr-2">ğŸ“…</span>
            <span v-else-if="channel.id === 'reports'" class="mr-2">ğŸ“‘</span>
            <span class="truncate">{{ channel.name }}</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="user-controls p-3 bg-discord-dark flex items-center">
      <div 
        @click="handleChannelAction('profile')"
        class="avatar w-8 h-8 rounded-full bg-discord-accent flex items-center justify-center text-white font-bold cursor-pointer hover-effect"
      >
        {{ userInitials }}
      </div>
      <div class="ml-2 flex-1">
        <div 
          @click="handleChannelAction('profile')" 
          class="text-sm text-white font-medium cursor-pointer hover-effect"
        >
          {{ userStore.username }}
        </div>
        <div class="text-xs flex items-center">
          <span class="px-1.5 py-0.5 bg-discord-accent rounded-sm text-white text-xs mr-1">
            {{ userStore.isTeacher ? $t('auth.teacher') : $t('auth.student') }}
          </span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ĞšĞ½Ğ¾Ğ¿ĞºĞ° Ğ´Ğ»Ñ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ Ğ¼ĞµĞ½Ñ Ğ½Ğ° Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ñ… ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ°Ñ… -->
  <div v-if="isMobile && !isOpen" 
       class="mobile-sidebar-toggle fixed top-16 left-4 z-50 bg-discord-accent rounded-full p-2 shadow-lg"
       @click="toggleSidebar">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
    </svg>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, onUnmounted, watch } from 'vue';
import { useUserStore } from '../../stores/user';
import { useChannelStore } from '../../stores/channels';
import { useI18n } from 'vue-i18n';
import { useRouter, useRoute, onBeforeRouteUpdate } from 'vue-router';
import mitt from 'mitt';

const userStore = useUserStore();
const channelStore = useChannelStore();
const { t } = useI18n();
const router = useRouter();
const route = useRoute();

// Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Event Bus
const emitter = mitt();

// Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Event Bus Ğ´Ğ»Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ² Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ°Ñ…
export const channelBus = {
  on: emitter.on,
  off: emitter.off,
  emit: emitter.emit
};

// Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ±Ğ¾ĞºĞ¾Ğ²Ğ¾Ğ¹ Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸
const isOpen = ref(false);
const isMobile = ref(false);

// ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ğ° Ğ¾ĞºĞ½Ğ°
const checkMobile = () => {
  isMobile.value = window.innerWidth < 768;
  if (!isMobile.value) {
    isOpen.value = true;
  } else {
    isOpen.value = false;
  }
};

const toggleSidebar = () => {
  isOpen.value = !isOpen.value;
};

// ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ĞºĞ°Ğ½Ğ°Ğ»Ñ‹ Ğ¸Ğ· ÑÑ‚Ğ¾Ñ€Ğ°
const channels = computed(() => channelStore.channels);

const currentChannel = computed({
  get: () => channelStore.currentChannelId,
  set: (value) => channelStore.setCurrentChannel(value)
});

const selectChannel = (channelId) => {
  handleChannelAction(channelId);
};

const userInitials = computed(() => {
  const username = userStore.username || '';
  return username.substring(0, 2).toUpperCase();
});

// ĞĞ°Ğ±Ğ»ÑĞ´ĞµĞ½Ğ¸Ğµ Ğ·Ğ° Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸ÑĞ¼Ğ¸ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ ĞºĞ°Ğ½Ğ°Ğ»Ğ°
watch(() => channelStore.currentChannelId, (newChannelId) => {
  console.log('Current channel ID changed in store:', newChannelId);
  // ĞĞ¿Ğ¾Ğ²ĞµÑ‰Ğ°ĞµĞ¼ Ğ²ÑĞµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹ Ğ¾ ÑĞ¼ĞµĞ½Ğµ ĞºĞ°Ğ½Ğ°Ğ»Ğ°
  channelBus.emit('channel-changed', newChannelId);
}, { immediate: true });

const handleChannelAction = (channelId) => {
  console.log('handleChannelAction called with:', channelId);
  
  try {
    // Ğ•ÑĞ»Ğ¸ ÑÑ‚Ğ¾ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğ¹ ĞºĞ°Ğ½Ğ°Ğ», Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ° ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚
    if (channelId === 'profile') {
      // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ ĞºĞ°Ğ½Ğ°Ğ» Ğ² query Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğµ
      const currentChannelId = channelStore.currentChannelId;
      
      console.log('Navigation to profile, saving channel:', currentChannelId);
      
      // ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ
      router.push({ 
        path: '/profile',
        query: { channel: currentChannelId }
      }).catch(err => {
        console.error('Navigation error:', err);
      });
      return;
    }
    
    // Ğ•ÑĞ»Ğ¸ Ğ¼Ñ‹ ÑƒĞ¶Ğµ Ğ½Ğ° Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ (teacher Ğ¸Ğ»Ğ¸ student)
    const routeName = router.currentRoute.value.name;
    const correctRouteName = userStore.isTeacher ? 'Teacher' : 'Student';
    
    // Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ĞºĞ°Ğ½Ğ°Ğ»
    currentChannel.value = channelId;
    channelStore.setCurrentChannel(channelId);
    console.log('Channel set to:', channelId);
    
    // Ğ•ÑĞ»Ğ¸ Ğ¼Ñ‹ Ğ½Ğµ Ğ½Ğ° Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ, Ğ¿ĞµÑ€ĞµĞ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼
    if (routeName !== correctRouteName) {
      console.log('Redirecting to correct page:', correctRouteName);
      router.push({
        path: userStore.isTeacher ? '/teacher' : '/student'
      }).catch(err => {
        console.error('Navigation error:', err);
      });
    }
  } catch (error) {
    console.error('Error in handleChannelAction:', error);
  }
  
  // Ğ—Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ ÑĞ°Ğ¹Ğ´Ğ±Ğ°Ñ€ Ğ½Ğ° Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¿Ğ¾ÑĞ»Ğµ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ°
  if (isMobile.value) {
    isOpen.value = false;
  }
};

// Computed ÑĞ²Ğ¾Ğ¹ÑÑ‚Ğ²Ğ° Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸Ñ ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ² Ğ¿Ğ¾ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°Ğ¼
const educationChannels = computed(() => {
  return channels.value.filter(channel => channel.group === 'education');
});

const analyticsChannels = computed(() => {
  return channels.value.filter(channel => channel.group === 'analytics');
});

// Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ĞºĞ°Ğ½Ğ°Ğ» Ğ¸Ğ· URL Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ°, ĞµÑĞ»Ğ¸ Ğ¾Ğ½ ĞµÑÑ‚ÑŒ
onMounted(() => {
  checkMobile();
  window.addEventListener('resize', checkMobile);
  
  // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ query-Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ Ğ¸Ğ· URL Ğ¿Ñ€Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğµ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğ½ÑƒÑ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ
  const route = router.currentRoute.value;
  const savedChannel = route.query.channel;
  
  // Ğ•ÑĞ»Ğ¸ Ñƒ Ğ½Ğ°Ñ ĞµÑÑ‚ÑŒ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ½Ñ‹Ğ¹ ĞºĞ°Ğ½Ğ°Ğ» Ğ¸ Ğ¼Ñ‹ Ğ½Ğµ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ,
  // Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ĞµĞ³Ğ¾ ĞºĞ°Ğº Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹
  if (savedChannel && route.name !== 'Profile') {
    channelStore.setCurrentChannel(savedChannel);
    
    // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ Ğ¸Ğ· URL Ğ¿Ñ€Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¸
    router.replace({ query: {} });
  }
});

// Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑĞ²Ğ½ÑƒÑ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºÑƒ ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ² Ğ¿Ñ€Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğµ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğ½ÑƒÑ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ
onBeforeRouteUpdate((to, from, next) => {
  console.log(`Route update: ${from.path} -> ${to.path}`);
  
  // Ğ•ÑĞ»Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ÑÑ Ğ¸Ğ· ProfileView Ğ¸ ĞµÑÑ‚ÑŒ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ½Ñ‹Ğ¹ ĞºĞ°Ğ½Ğ°Ğ»,
  // Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞµĞ¼ ĞµĞ³Ğ¾
  if (from.name === 'Profile' && to.name !== 'Profile') {
    if (from.query.channel) {
      console.log('Route update: Restoring channel from profile:', from.query.channel);
      channelStore.setCurrentChannel(from.query.channel);
    }
    
    // ĞŸÑ€Ğ¸Ğ½ÑƒĞ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ²
    channels.value = [...channelStore.channels];
  }
  
  next();
});

onUnmounted(() => {
  window.removeEventListener('resize', checkMobile);
});

// ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹ Ğ´Ğ»Ñ ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ²
// Ğ­ĞºÑÑ‚Ñ€Ğ°ĞºÑ‚Ğ¸Ğ¼ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ ÑĞ¿Ğ¸ÑĞºĞ° ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ² Ğ² Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ´Ğ»Ñ Ğ±Ğ¾Ğ»ÑŒÑˆĞµĞ¹ Ğ½Ğ°Ğ´ĞµĞ¶Ğ½Ğ¾ÑÑ‚Ğ¸
const renderChannelItem = (channel) => {
  // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼, ĞºĞ°ĞºÑƒÑ Ğ¸ĞºĞ¾Ğ½ĞºÑƒ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°Ñ‚ÑŒ Ğ´Ğ»Ñ ĞºĞ°Ğ½Ğ°Ğ»Ğ°
  const getChannelIcon = (channelId) => {
    if (channelId === 'lecture') return <span class="mr-2">ğŸ“</span>;
    if (channelId === 'student-management') return <span class="mr-2">ğŸ‘¥</span>;
    if (channelId === 'assignments') return <span class="mr-2">ğŸ“š</span>;
    if (channelId === 'tests') return <span class="mr-2">ğŸ“Š</span>;
    if (channelId === 'resources') return <span class="mr-2">ğŸ“‚</span>;
    if (channelId === 'student-progress') return <span class="mr-2">ğŸ“ˆ</span>;
    if (channelId === 'attendance') return <span class="mr-2">ğŸ“…</span>;
    if (channelId === 'reports') return <span class="mr-2">ğŸ“‘</span>;
    return <span class="mr-2">#</span>;
  };
  
  return (
    <div
      class={`channel-item flex items-center px-2 py-1 rounded cursor-pointer ${currentChannel.value === channel.id ? 'bg-discord-dark-hover' : ''}`}
      onClick={() => handleChannelAction(channel.id)}
    >
      {getChannelIcon(channel.id)}
      <span class="truncate">{channel.name}</span>
    </div>
  );
};

// ĞŸÑ€Ğ¸Ğ½ÑƒĞ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ² Ğ¿Ñ€Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸ÑÑ…
watch(channelStore.currentChannelId, (newId) => {
  // ĞĞ±ĞµÑĞ¿ĞµÑ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ€ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ ĞºĞ°Ğ½Ğ°Ğ»Ğ°
  currentChannel.value = newId;
  console.log('Channel ID changed in Sidebar:', newId);
});
</script>

<style scoped>
.sidebar {
  transition: width 0.3s ease;
  overflow: hidden;
}

.mobile-sidebar-toggle {
  transition: all 0.3s ease;
}

.channels-list {
  max-height: 300px;
  overflow-y: auto;
}

.channels-list::-webkit-scrollbar {
  width: 4px;
}

.channels-list::-webkit-scrollbar-track {
  background: transparent;
}

.channels-list::-webkit-scrollbar-thumb {
  background-color: rgba(114, 118, 125, 0.3);
  border-radius: 2px;
}

/* ĞĞ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ğ½Ğ°Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğ¸ */
.channel-item {
  transition: all 0.2s ease;
}

.channel-item:hover {
  background-color: rgba(79, 84, 92, 0.4);
  transform: translateX(3px);
}

.hover-effect {
  transition: all 0.2s ease;
}

.hover-effect:hover {
  opacity: 0.8;
  transform: scale(1.05);
}
</style>
